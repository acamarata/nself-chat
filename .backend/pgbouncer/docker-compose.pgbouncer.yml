version: '3.8'

# ============================================================================
# PgBouncer Connection Pooler for PostgreSQL
# ============================================================================
# Add this to your existing docker-compose.yml or run separately
# Usage: docker-compose -f docker-compose.pgbouncer.yml up -d
# ============================================================================

services:
  pgbouncer:
    image: edoburu/pgbouncer:1.22
    container_name: nchat-pgbouncer
    restart: unless-stopped

    environment:
      # Database configuration
      - DATABASE_URL=postgres://postgres:postgres@postgres:5432/postgres

      # Pool configuration
      - POOL_MODE=transaction
      - MAX_CLIENT_CONN=10000
      - DEFAULT_POOL_SIZE=25
      - MIN_POOL_SIZE=10
      - RESERVE_POOL_SIZE=5
      - MAX_DB_CONNECTIONS=100

      # Timeouts
      - SERVER_IDLE_TIMEOUT=600
      - CLIENT_IDLE_TIMEOUT=0
      - QUERY_WAIT_TIMEOUT=120

      # Logging
      - LOG_CONNECTIONS=1
      - LOG_DISCONNECTIONS=1
      - STATS_PERIOD=60

    ports:
      - "6432:6432"

    volumes:
      - ./pgbouncer/pgbouncer.ini:/etc/pgbouncer/pgbouncer.ini:ro
      - ./pgbouncer/userlist.txt:/etc/pgbouncer/userlist.txt:ro

    networks:
      - nchat-network

    depends_on:
      - postgres

    healthcheck:
      test: ["CMD", "pg_isready", "-h", "localhost", "-p", "6432", "-U", "postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M

  # PostgreSQL service (reference - should already exist)
  postgres:
    image: postgres:16-alpine
    container_name: nchat-postgres
    # ... existing postgres configuration ...

networks:
  nchat-network:
    external: true
    name: nchat-network

# ============================================================================
# Usage Instructions
# ============================================================================
# 1. Start PgBouncer:
#    docker-compose -f docker-compose.pgbouncer.yml up -d
#
# 2. Connect to PgBouncer instead of PostgreSQL directly:
#    postgresql://postgres:postgres@localhost:6432/nchat
#
# 3. Access admin console:
#    psql -h localhost -p 6432 -U postgres pgbouncer
#    pgbouncer=# SHOW POOLS;
#    pgbouncer=# SHOW STATS;
#    pgbouncer=# SHOW DATABASES;
#
# 4. Monitor performance:
#    docker logs -f nchat-pgbouncer
#
# 5. Update configuration:
#    - Edit pgbouncer.ini
#    - docker-compose -f docker-compose.pgbouncer.yml restart
# ============================================================================
