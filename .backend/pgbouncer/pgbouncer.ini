;; ============================================================================
;; PgBouncer Configuration for High Concurrency
;; ============================================================================
;; Optimized for 10,000 concurrent users with connection pooling
;; Version: 1.22+
;; ============================================================================

[databases]
;; Database connection string
;; Format: dbname = host=hostname port=5432 dbname=database user=username password=password
nchat = host=postgres port=5432 dbname=postgres user=postgres password=postgres

;; Fallback pool (optional)
* = host=postgres port=5432

[pgbouncer]
;; ============================================================================
;; Connection Settings
;; ============================================================================

;; Listen address and port
listen_addr = 0.0.0.0
listen_port = 6432

;; Unix socket (optional, for local connections)
unix_socket_dir = /tmp
unix_socket_mode = 0777

;; ============================================================================
;; Authentication
;; ============================================================================

;; Authentication type: md5, scram-sha-256, plain, trust, any, hba, pam
auth_type = md5

;; Authentication file (userlist.txt)
auth_file = /etc/pgbouncer/userlist.txt

;; ============================================================================
;; Pooling Settings - CRITICAL FOR PERFORMANCE
;; ============================================================================

;; Pooling mode
;; - session: One server connection per client connection (default)
;; - transaction: Server connection released after each transaction
;; - statement: Server connection released after each statement (not recommended)
pool_mode = transaction

;; Maximum number of client connections allowed
max_client_conn = 10000

;; Default pool size per user/database pair
default_pool_size = 25

;; Minimum pool size (pre-allocated connections)
min_pool_size = 10

;; Reserve pool size (emergency connections)
reserve_pool_size = 5

;; Maximum database connections per user/database pair
;; Should be <= PostgreSQL max_connections
max_db_connections = 100

;; Maximum concurrent connections per user
max_user_connections = 100

;; ============================================================================
;; Connection Limits and Timeouts
;; ============================================================================

;; Server lifetime (seconds) - force reconnect after this time
server_lifetime = 3600

;; Server idle timeout (seconds) - close unused connections
server_idle_timeout = 600

;; Server connection attempt timeout
server_connect_timeout = 15

;; Server login retry delay
server_login_retry = 15

;; Client idle timeout (seconds)
client_idle_timeout = 0

;; Client login timeout
client_login_timeout = 60

;; Query timeout (seconds) - cancel long-running queries
query_timeout = 0

;; Query wait timeout - time client can wait for server connection
query_wait_timeout = 120

;; ============================================================================
;; Performance Tuning
;; ============================================================================

;; TCP keepalive settings
tcp_keepalive = 1
tcp_keepidle = 60
tcp_keepintvl = 10
tcp_keepcnt = 5

;; TCP user timeout (milliseconds)
tcp_user_timeout = 0

;; DNS cache time (seconds)
dns_max_ttl = 15
dns_nxdomain_ttl = 15

;; DNS lookup zone
dns_zone_check_period = 0

;; Packet buffer size
pkt_buf = 4096

;; Maximum packet size
max_packet_size = 2147483647

;; Listen queue backlog
listen_backlog = 4096

;; Server round-robin
server_round_robin = 0

;; Disable PQEXEC for better performance with prepared statements
disable_pqexec = 0

;; ============================================================================
;; Logging
;; ============================================================================

;; Log level: DEBUG, INFO, WARNING, ERROR
log_level = INFO

;; Log connections
log_connections = 1

;; Log disconnections
log_disconnections = 1

;; Log pooler errors
log_pooler_errors = 1

;; Log statistics
log_stats = 1

;; Stats period (seconds)
stats_period = 60

;; Syslog integration
syslog = 0
syslog_ident = pgbouncer
syslog_facility = daemon

;; ============================================================================
;; Security
;; ============================================================================

;; Ignore startup parameters from clients
ignore_startup_parameters = extra_float_digits

;; Application name passthrough
application_name_add_host = 0

;; TLS/SSL settings (if needed)
;; client_tls_sslmode = disable
;; client_tls_ca_file = /path/to/ca.crt
;; client_tls_cert_file = /path/to/client.crt
;; client_tls_key_file = /path/to/client.key

;; server_tls_sslmode = disable
;; server_tls_ca_file = /path/to/ca.crt
;; server_tls_cert_file = /path/to/server.crt
;; server_tls_key_file = /path/to/server.key

;; ============================================================================
;; Admin Console
;; ============================================================================

;; Admin users (comma-separated)
admin_users = postgres

;; Stats users (can view stats but not modify)
stats_users = stats

;; ============================================================================
;; Advanced Settings
;; ============================================================================

;; Server reset query (run when connection is returned to pool)
;; server_reset_query = DISCARD ALL
server_reset_query = RESET ALL

;; Server check query (health check)
server_check_query = SELECT 1

;; Server check delay (seconds between health checks)
server_check_delay = 30

;; Server fast close (drop connections immediately on shutdown)
server_fast_close = 0

;; Autodb idle timeout
autodb_idle_timeout = 3600

;; Suspend timeout
suspend_timeout = 10

;; Verbose mode
verbose = 0

;; ============================================================================
;; Per-Database Settings (Override defaults)
;; ============================================================================

[databases:nchat]
;; pool_size = 50
;; max_db_connections = 150

;; ============================================================================
;; NOTES
;; ============================================================================
;; 1. Adjust pool sizes based on your PostgreSQL max_connections
;; 2. monitor PgBouncer stats: SHOW STATS; SHOW POOLS; SHOW DATABASES;
;; 3. For 10k concurrent users, ensure PostgreSQL has:
;;    - max_connections >= 200
;;    - shared_buffers >= 4GB
;;    - effective_cache_size >= 12GB
;; 4. Use transaction pooling for best performance with web apps
;; 5. Monitor wait times and adjust pool sizes if queries are queuing
;; ============================================================================
