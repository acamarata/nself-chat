name: Release v0.8.0

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., 0.8.0)'
        required: true
        type: string
      version_type:
        description: 'Version bump type'
        required: true
        default: 'minor'
        type: choice
        options:
          - patch
          - minor
          - major
      prerelease:
        description: 'Is this a pre-release?'
        required: false
        default: false
        type: boolean
      deploy_mobile:
        description: 'Deploy mobile apps'
        required: false
        default: false
        type: boolean
      deploy_desktop:
        description: 'Deploy desktop apps'
        required: false
        default: false
        type: boolean

permissions:
  contents: write
  packages: write
  id-token: write

env:
  NODE_VERSION: '20'
  PNPM_VERSION: '9.15.4'
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  prepare:
    name: Prepare Release
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      tag: ${{ steps.version.outputs.tag }}
      changelog: ${{ steps.changelog.outputs.changelog }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Configure Git
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"

      - name: Determine version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
            TAG="v${VERSION}"

            # Update package.json version
            chmod +x scripts/version-bump.sh
            scripts/version-bump.sh "$VERSION"

          else
            TAG="${GITHUB_REF#refs/tags/}"
            VERSION="${TAG#v}"
          fi

          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "tag=${TAG}" >> $GITHUB_OUTPUT

      - name: Generate changelog
        id: changelog
        run: |
          chmod +x scripts/generate-changelog.sh
          scripts/generate-changelog.sh "${{ steps.version.outputs.version }}"

          # Extract changelog entry for this version
          CHANGELOG=$(awk '/## \[${{ steps.version.outputs.version }}\]/,/## \[/' CHANGELOG.md | head -n -1)

          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Commit version bump and changelog
        if: github.event_name == 'workflow_dispatch'
        run: |
          git add package.json CHANGELOG.md
          git commit -m "chore: release v${{ steps.version.outputs.version }}"
          git tag -a "${{ steps.version.outputs.tag }}" -m "Release ${{ steps.version.outputs.version }}"
          git push origin main --follow-tags

      - name: Upload changelog
        uses: actions/upload-artifact@v4
        with:
          name: changelog
          path: CHANGELOG.md

  build-web:
    name: Build Web Application
    runs-on: ubuntu-latest
    needs: [prepare]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Get pnpm store directory
        id: pnpm-cache
        shell: bash
        run: echo "STORE_PATH=$(pnpm store path)" >> $GITHUB_OUTPUT

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ steps.pnpm-cache.outputs.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: ${{ runner.os }}-pnpm-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build web app
        run: pnpm build
        env:
          NEXT_PUBLIC_USE_DEV_AUTH: 'false'
          NODE_ENV: production

      - name: Create web artifact
        run: |
          tar -czvf nself-chat-web-${{ needs.prepare.outputs.version }}.tar.gz \
            .next \
            public \
            package.json \
            pnpm-lock.yaml \
            next.config.js

      - name: Upload web artifact
        uses: actions/upload-artifact@v4
        with:
          name: web-build
          path: nself-chat-web-${{ needs.prepare.outputs.version }}.tar.gz

  build-docker:
    name: Build Docker Images
    runs-on: ubuntu-latest
    needs: [prepare]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=semver,pattern={{version}},value=${{ needs.prepare.outputs.version }}
            type=semver,pattern={{major}}.{{minor}},value=${{ needs.prepare.outputs.version }}
            type=semver,pattern={{major}},value=${{ needs.prepare.outputs.version }}
            type=raw,value=latest,enable=${{ github.event.inputs.prerelease != 'true' }}

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64,linux/arm64
          build-args: |
            VERSION=${{ needs.prepare.outputs.version }}

  build-mobile:
    name: Build Mobile Apps
    if: github.event.inputs.deploy_mobile == 'true' || github.ref == 'refs/heads/main'
    needs: [prepare]
    strategy:
      matrix:
        platform: [ios, android]
    uses: ./.github/workflows/${{ matrix.platform }}-build.yml
    with:
      build_type: release
      deploy_testflight: ${{ matrix.platform == 'ios' && github.event.inputs.deploy_mobile == 'true' }}
      deploy_playstore: ${{ matrix.platform == 'android' && github.event.inputs.deploy_mobile == 'true' }}
    secrets: inherit

  build-desktop:
    name: Build Desktop Apps
    if: github.event.inputs.deploy_desktop == 'true' || github.ref == 'refs/heads/main'
    needs: [prepare]
    uses: ./.github/workflows/desktop-build.yml
    with:
      platform: all
      framework: electron
      create_release: false
    secrets: inherit

  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [prepare, build-web, build-docker]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download web artifact
        uses: actions/download-artifact@v4
        with:
          name: web-build
          path: ./artifacts

      - name: Download changelog
        uses: actions/download-artifact@v4
        with:
          name: changelog
          path: ./

      - name: Download mobile artifacts
        if: github.event.inputs.deploy_mobile == 'true'
        uses: actions/download-artifact@v4
        with:
          pattern: nchat-*-${{ needs.prepare.outputs.version }}-*
          path: ./artifacts/mobile

      - name: Download desktop artifacts
        if: github.event.inputs.deploy_desktop == 'true'
        uses: actions/download-artifact@v4
        with:
          pattern: electron-*-${{ needs.prepare.outputs.version }}
          path: ./artifacts/desktop

      - name: Create release body
        run: |
          cat > release-body.md <<EOF
          # nself-chat v${{ needs.prepare.outputs.version }}

          ${{ needs.prepare.outputs.changelog }}

          ## Installation

          ### Docker
          \`\`\`bash
          docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ needs.prepare.outputs.version }}
          docker run -p 3000:3000 ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ needs.prepare.outputs.version }}
          \`\`\`

          ### Web (Self-hosted)
          Download the web artifact, extract, and run:
          \`\`\`bash
          tar -xzf nself-chat-web-${{ needs.prepare.outputs.version }}.tar.gz
          pnpm install
          pnpm start
          \`\`\`

          ### Mobile Apps
          - **iOS**: Available on TestFlight (invite required)
          - **Android**: Download APK/AAB from artifacts below

          ### Desktop Apps
          - **macOS**: Download .dmg from artifacts below
          - **Windows**: Download .exe from artifacts below
          - **Linux**: Download .AppImage, .deb, or .rpm from artifacts below

          ## Documentation
          - [Installation Guide](https://github.com/${{ github.repository }}/blob/main/README.md)
          - [API Documentation](https://github.com/${{ github.repository }}/blob/main/docs/API.md)
          - [Deployment Guide](https://github.com/${{ github.repository }}/blob/main/scripts/DEPLOYMENT-README.md)

          ## Support
          - ðŸ“§ Email: support@nself.org
          - ðŸ’¬ Discord: https://discord.gg/nself
          - ðŸ“š Docs: https://docs.nself.org

          ---
          **Full Changelog**: https://github.com/${{ github.repository }}/compare/v0.7.0...v${{ needs.prepare.outputs.version }}
          EOF

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.prepare.outputs.tag }}
          name: Release ${{ needs.prepare.outputs.version }}
          body_path: release-body.md
          draft: false
          prerelease: ${{ github.event.inputs.prerelease == 'true' }}
          files: |
            ./artifacts/**/*
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [prepare, create-release]
    if: github.event.inputs.prerelease != 'true'
    environment:
      name: production
      url: https://nchat.io
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build
        run: pnpm build
        env:
          NEXT_PUBLIC_USE_DEV_AUTH: 'false'
          NODE_ENV: production

      - name: Deploy to Vercel
        if: secrets.VERCEL_TOKEN != ''
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          vercel-args: '--prod'
          scope: ${{ secrets.VERCEL_ORG_ID }}

  notify:
    name: Send Notifications
    runs-on: ubuntu-latest
    needs: [prepare, create-release, deploy-production]
    if: always()
    steps:
      - name: Determine status
        id: status
        run: |
          if [ "${{ needs.create-release.result }}" = "success" ]; then
            echo "emoji=ðŸš€" >> $GITHUB_OUTPUT
            echo "status=Success" >> $GITHUB_OUTPUT
            echo "color=good" >> $GITHUB_OUTPUT
          else
            echo "emoji=âŒ" >> $GITHUB_OUTPUT
            echo "status=Failed" >> $GITHUB_OUTPUT
            echo "color=danger" >> $GITHUB_OUTPUT
          fi

      - name: Notify Slack
        if: secrets.SLACK_WEBHOOK_URL != ''
        uses: slackapi/slack-github-action@v1
        with:
          payload: |
            {
              "text": "${{ steps.status.outputs.emoji }} Release v${{ needs.prepare.outputs.version }} ${{ steps.status.outputs.status }}",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "${{ steps.status.outputs.emoji }} nself-chat v${{ needs.prepare.outputs.version }} Released!"
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Version:*\nv${{ needs.prepare.outputs.version }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Status:*\n${{ steps.status.outputs.status }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Platforms:*\nWeb, Docker, Mobile, Desktop"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Environment:*\nProduction"
                    }
                  ]
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Docker Image:*\n`docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ needs.prepare.outputs.version }}`"
                  }
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "View Release"
                      },
                      "url": "https://github.com/${{ github.repository }}/releases/tag/v${{ needs.prepare.outputs.version }}"
                    },
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "View Changelog"
                      },
                      "url": "https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md"
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK

      - name: Send email notification
        if: secrets.SENDGRID_API_KEY != ''
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.sendgrid.net
          server_port: 587
          username: apikey
          password: ${{ secrets.SENDGRID_API_KEY }}
          subject: "${{ steps.status.outputs.emoji }} nself-chat v${{ needs.prepare.outputs.version }} Released"
          to: ${{ secrets.RELEASE_EMAIL_TO }}
          from: releases@nself.org
          body: |
            nself-chat v${{ needs.prepare.outputs.version }} has been released!

            Status: ${{ steps.status.outputs.status }}

            Release Notes:
            https://github.com/${{ github.repository }}/releases/tag/v${{ needs.prepare.outputs.version }}

            Docker:
            docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ needs.prepare.outputs.version }}

            Changelog:
            https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md

      - name: Create Twitter/X announcement
        if: secrets.TWITTER_API_KEY != '' && needs.create-release.result == 'success'
        run: |
          echo "ðŸš€ nself-chat v${{ needs.prepare.outputs.version }} is now available!" > tweet.txt
          echo "" >> tweet.txt
          echo "âœ¨ New features, improvements, and bug fixes" >> tweet.txt
          echo "ðŸ“¦ Available for Web, Mobile, and Desktop" >> tweet.txt
          echo "" >> tweet.txt
          echo "https://github.com/${{ github.repository }}/releases/tag/v${{ needs.prepare.outputs.version }}" >> tweet.txt
          echo "#nchat #opensource #teamchat" >> tweet.txt

          # Note: Actual Twitter posting would require Twitter API integration
          cat tweet.txt

      - name: Update status badge
        run: |
          echo "Latest release: v${{ needs.prepare.outputs.version }}" > .release-status
          echo "Status: ${{ steps.status.outputs.status }}" >> .release-status
          echo "Date: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> .release-status
